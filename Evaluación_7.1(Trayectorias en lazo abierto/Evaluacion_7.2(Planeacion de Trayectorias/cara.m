%% EXAMPLE: Differential drive vehicle following waypoints using the 
% Pure Pursuit algorithm
%
% Copyright 2018-2019 The MathWorks, Inc.

%% Define Vehicle
R = 0.1;                % Wheel radius [m]
L = 0.5;                % Wheelbase [m]
dd = DifferentialDrive(R,L);

%% Simulation parameters
sampleTime = 0.1;               % Sample time [s]
tVec = 0:sampleTime:1;         % Time array

initPose = [0;0;0];             % Initial pose (x y theta)
pose = zeros(3,numel(tVec));    % Pose matrix
pose(:,1) = initPose;

% Define waypoints
waypoints = [0,0;
             0.9708932296487,0.4994272253156;
             2.0012539147117,0.5143599888672;
             2.9868163091198,0.4994272253156;
             3.9126476493213,0.5591582795221;
             5.0176721521425,0.6188893337287;
             5.8987052016891,0.5890238066254;
             5.91,2.35; 
             5.72, 2.49;
             5.47, 2.64
             5.1581507425912,2.8195362289867;
             4.8624820242688,2.9509445482411;
             4.4573063732344,3.2028104934787;
             4.1287855750984,3.4765778252587;
             4.2601938943528,3.816049316666;
             4.2930459741664,3.9912604090052;
             4.3039966674376,4.2321756609716;
             4.2820952808952,4.473090912938;
             4.2273418145392,4.7578089379893;
             4.161637654912,5.0534776563117;
             4.0302293356575,5.2396394419221;
             3.5155467519111,5.2834422150069;
             2.9899134748935,5.2943929082781;
             2.3985760382486,5.2286887486509;
             2,5;
             1.8072386016038,4.8892172572437;
             1.6539288958069,4.9768228034133;
             1.4677671101965,5.1739352822949;
             1.3911122572981,5.3491463746341;
             1.5444219630949,5.5024560804309;
             1.872942761231,5.5791109333293;
             2.310970492079,5.6119630131429;
             2.694244756571,5.6557657862277;
             3.1213217941479,5.6667164794989;
             3.7017085375215,5.6448150929565;
             4.0302293356575,5.6119630131429;
             4.271144587624,5.5462588535157;
             4.4463556799632,5.1958366688373;
             4.1944897347256,5.9295331180078;
             3.9754758693015,6.323758075771;
             3.5593495249959,6.542771941195;
             3.1651245672327,6.6303774873646;
             2.8913572354526,6.6851309537206;
             2.5518857440454,6.542771941195;
             2.1576607862822,6.3347087690422;
             1.8510413746886,5.9076317314654;
             1.927696227587,4.6154499254636;
             1.927696227587,4.3745346734972;
             1.982449693943,4.144570114802;
             2.0810059333838,3.8270000099372;
             2.1795621728246,3.5641833714284;
             2.3328718786214,3.3232681194619;
             2.529984357503,3.1261556405803;
             2.7708996094694,2.9509445482411;
             3.0665683277919,2.8414376155291;
             3.4717439788263,2.9290431616987;
             3.8550182433183,3.1590077203939;
             3.6688564577079,3.4108736656315;
             3.5374481384535,3.651788917598;
             3.3184342730295,3.7831972368524;
             3.0665683277919,3.7503451570388;
             2.8694558489102,3.8050986233948;
             2.6285405969438,3.6408382243268;
             2.7928009960118,3.5094299050724;
             3.0118148614359,3.4984792118012;
             3.1760752605039,3.4327750521739;
             3.4169905124703,3.5319396634631;
             3.0519674034303,4.013770167396;
             3.1736417731103,4.1013757135656;
             3.3050500923647,4.0770408396296;
             3.4267244620447,4.1159766379272;
             3.4169905124703,4.2619858815432;
             3.5337979073631,4.2473849571816;
             3.6798071509791,4.2230500832456;
             3.8355503441695,4.2619858815432;
             4,4.4;
             4.0545642095936,4.5394034444136;
             4.0788990835296,4.7097475619656;
             4.0545642095936,4.8752247047305;
             3.8890870668287,4.9579632761129;
             3.7090089997023,4.9774311752617;
             3.4899951342783,4.9822981500489;
             3.1347059748127,4.9774311752617;
             2.8378205127934,4.9579632761129;
             2.5652699247102,4.9384953769641;
             2.244049588755,4.8898256290921;
             2.0542375720542,4.7973531081353;
             2.0153017737566,4.5296694948392;
             2.1661779921598,4.2765868059048;
             2.3511230340734,4.1792473101608;
             2.6188066473694,4.23278403282;
             2.8329535380062,4.4079951251592;
             2.9205590841759,4.646476889732;
             2.8767563110911,4.7730182341993;
             3.1736417731103,4.7827521837737;
             3.1687747983231,4.6026741166472;
             3.2612473192799,4.4323299990952;
             3.3245179915135,4.3544584025;
             3.2271784957695,4.281453780692;
             3.0665683277919,4.3349905033512;
             2.8718893363039,4.3155226042024;
             2.7940177397086,4.2668528563304;
             2.706412193539,4.135444537076;
             2.7891507649214,4.0527059656936;
             2.9302930337503,4.1159766379272;
             2.2999091857445,3.0081315019907;
             2.0012539147117,2.873736630026;
             1.6279348259208,2.6497451767514;
             1.3591450819913,2.3809554328219;
             1.1799519193716,1.9329725262728;
             1.0903553380618,1.470056856172;
             1,1;
             0.9708932296487,0.4994272253156;
             2.0012539147117,0.5143599888672;
             2.9868163091198,0.4994272253156;
             3.9126476493213,0.5591582795221;
             5.0176721521425,0.6188893337287;
             5.8987052016891,0.5890238066254;
             ];

% Create visualizer
viz = Visualizer2D;
viz.hasWaypoints = true;

%% Pure Pursuit Controller
controller = controllerPurePursuit;
controller.Waypoints = waypoints;
controller.LookaheadDistance = 0.1;
controller.DesiredLinearVelocity = 0.5;
controller.MaxAngularVelocity = 10;

%% Simulation loop
close all
r = rateControl(1/sampleTime);
for idx = 2:numel(tVec) 
    % Run the Pure Pursuit controller and convert output to wheel speeds
    [vRef,wRef] = controller(pose(:,idx-1));
    [wL,wR] = inverseKinematics(dd,vRef,wRef);
    
    % Compute the velocities
    [v,w] = forwardKinematics(dd,wL,wR);
    velB = [v;0;w]; % Body velocities [vx;vy;w]
    vel = bodyToWorld(velB,pose(:,idx-1));  % Convert from body to world
    
    % Perform forward discrete integration step 
    pose(:,idx) = pose(:,idx-1) + vel*sampleTime; 
    
    % Update visualization
    viz(pose(:,idx),waypoints)
    waitfor(r);
end